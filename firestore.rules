rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to validate timestamp freshness
    function isRecentTimestamp(timestamp) {
      return timestamp > request.time - duration.value(5, 'm');
    }
    
    // Helper to check if user is authenticated owner
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Helper to check if field is unchanged
    function fieldUnchanged(field) {
      return resource.data[field] == request.resource.data[field];
    }
    
    // Users collection - worker-authoritative model
    match /users/{userId} {
      // Users can read their own document
      allow read: if isOwner(userId);
      
      // Only allow user to update specific fields (UPI, withdrawal request)
      // Most updates come through the secure worker
      allow update: if isOwner(userId)
                    && fieldUnchanged('deviceId')
                    && fieldUnchanged('email')
                    && fieldUnchanged('referralCode')
                    && fieldUnchanged('createdAt')
                    && fieldUnchanged('totalTaps')  // Only worker can update
                    && fieldUnchanged('totalCoins') // Only worker can update
                    && fieldUnchanged('lifetimeCoins') // Only worker can update
                    && fieldUnchanged('completedMissionIds') // Only worker can update
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['upiId', 'withdrawalStatus', 'pendingWithdrawalAmount', 'lastWithdrawalDate', 'hapticEnabled']);
      
      // Allow create during registration with required fields
      allow create: if isOwner(userId)
                    && request.resource.data.deviceId != null
                    && request.resource.data.email != null
                    && request.resource.data.referralCode != null
                    && request.resource.data.totalCoins == 0
                    && request.resource.data.totalTaps == 0;
      
      // Never allow delete
      allow delete: if false;
    }
    
    // Withdrawals collection for audit trail
    match /withdrawals/{withdrawalId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.amount >= 100000  // Minimum 100k coins
                    && request.resource.data.status == 'pending';
      allow update, delete: if false; // Admin only via backend
    }
    
    // Referrals tracking with abuse prevention
    match /referrals/{referralId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
                    && request.resource.data.timestamp != null
                    && isRecentTimestamp(request.resource.data.timestamp);
      allow update, delete: if false;
    }
    
    // Security logs (write-only for client)
    match /security_logs/{logId} {
      allow read: if false; // Admin only
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // Sync history for anti-replay verification
    match /sync_history/{syncId} {
      allow read: if false; // Worker only via admin SDK
      allow create, update, delete: if false; // Worker only
    }
  }
}
